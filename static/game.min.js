var game;window.addEventListener("DOMContentLoaded",function(){game=new Game,game.start()});var Game=function(){this.canvas=document.getElementById("renderCanvas"),this.engine=new BABYLON.Engine(this.canvas,!0),this.keys={left:0,right:0,fire:0},this.isFireing=!1,this.readyForData=!0,this.Motors={motor1:new Game.Motor("motor1")},this.get_data=function(){this.readyForData=!1,new Game.Ajax("/data.json",function(a){conosle.log(a),this.readyForData=!0})},this.createScene=function(){var a=new BABYLON.Scene(this.engine),b=new Game.Camera("MainCam",a);this.arScreen=new Game.ARScreen(a,b);new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0,1,0),a);return this.sphere=BABYLON.Mesh.CreateSphere("sphere1",16,2,a),this.sphere.movingDir="up",this.sphere.position.z=60,this.target=new Game.Overlay(a,"target.png"),a},this.scene=this.createScene(),this.start=function(){this.engine.runRenderLoop(this.loopFunction),window.addEventListener("keydown",this.handleKeyDown.bind(this),!1),window.addEventListener("keyup",this.handleKeyUp.bind(this),!1),window.addEventListener("resize",function(){this.engine.resize()})},this.loopFunction=function(){this.readyForData&&this.get_data(),1==this.keys.left&&(this.scene.cameras[0].cameraRotation.y-=.001),1==this.keys.right&&(this.scene.cameras[0].cameraRotation.y+=.001),1!=this.keys.fire||this.isFireing||(console.log("Fire!"),console.log("I need to do a raycasting right here"),this.isFireing=!0,this.castRay()),"up"==this.sphere.movingDir?(this.sphere.position.y-=.2,this.sphere.position.y<-8&&(console.log("I need to change"),this.sphere.movingDir="down")):"down"==this.sphere.movingDir&&(this.sphere.position.y+=.2,this.sphere.position.y>8&&(this.sphere.movingDir="up")),this.sphere.position.z-=.4,this.sphere.position.z<0&&(this.sphere.position.z=105),this.scene.render(),this.arScreen.update()}.bind(this),this.handleKeyDown=function(a){65==a.keyCode&&(this.keys.left=1,this.Motors.motor1.activated("positive")),68==a.keyCode&&(this.keys.right=1,this.Motors.motor1.activated("negative")),32==a.keyCode&&(this.keys.fire=1)},this.handleKeyUp=function(a){65==a.keyCode&&(this.keys.left=0,this.Motors.motor1.deactivated("positive")),68==a.keyCode&&(this.keys.right=0,this.Motors.motor1.deactivated("negative")),32==a.keyCode&&(this.keys.fire=0,this.isFireing=!1)},this.vecToLocal=function(a,b){var c=b.getWorldMatrix();return BABYLON.Vector3.TransformCoordinates(a,c)},this.castRay=function(){var a=this.scene.cameras[0].position,b=new BABYLON.Vector3(0,0,1);b=this.vecToLocal(b,this.scene.cameras[0]);var c=b.subtract(a);c=BABYLON.Vector3.Normalize(c);var d=300,e=new BABYLON.Ray(a,c,d),f=this.scene.pickWithRay(e);f.pickedMesh==this.sphere&&(f.pickedMesh.scaling.y+=.5,f.pickedMesh.scaling.x+=.5)}};Game.ARScreen=function(a,b){this.videoCanvas=document.createElement("canvas"),this.videoCanvas.id="jpgs",this.screen=BABYLON.Mesh.CreatePlane("ArScreen",100,a),this.screen.scaling.y=.5,this.screen.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL,this.screen.position=new BABYLON.Vector3(0,0,60);var c=new BABYLON.StandardMaterial("mat",a);return this.canvasTexture=new BABYLON.DynamicTexture("dynamic texture",this.videoCanvas,a,!0),c.diffuseTexture=this.canvasTexture,this.screen.material=c,this.screen.parent=b.bCamera,this.loadImage=function(){var a=this.videoCanvas.getContext("2d"),b=new Image;b.onload=function(){a.drawImage(b,0,0)},b.src="http://localhost:5000/image.jpg?"+(new Date).getTime()},this.update=function(){this.loadImage(),this.canvasTexture.update()},this},Game.Ajax=function(a,b){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.onreadystatechange=function(){4==c.readyState&&200==c.status&&c.responseText&&(console.log("I Should have a callback here"),console.log(c.responseText))},c.open("GET",a,!0),c.send(null)},Game.Camera=function(a,b){return this.bCamera=new BABYLON.FreeCamera(a,new BABYLON.Vector3(0,0,0),b),this.bCamera.setTarget(BABYLON.Vector3.Zero()),this},Game.Motor=function(a){this.name=a,this.atEnd={positive:!1,negative:!1},this.activated=function(b){new Game.Ajax("/activated?motor="+a+"&dir="+b,function(a){console.log(a)})},this.deactivated=function(b){new Game.Ajax("/deactivted?motor="+a+"&dir="+b,function(a){console.log(a)})},this.checkEndStop=function(b){new Game.Ajax("/checkEndStop?motor="+a+"&dir="+b,function(a){"false"==a?this.atEnd[position]=!1:"true"==a&&(this.atEnd[position]=!0)})}},Game.Overlay=function(a,b){return this.canvas=new BABYLON.ScreenSpaceCanvas2D(a,{id:"overlayCanvas"}),this.texture=new BABYLON.Texture(b,a,!1,!0,1),this.texture.hasAlpha=!0,this.sprite=new BABYLON.Sprite2D(this.texture,{parent:this.canvas,id:"sprite1",marginAlignment:"h: center, v: center"}),this};