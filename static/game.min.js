var Game=function(){this.canvas=document.getElementById("renderCanvas"),this.engine=new BABYLON.Engine(this.canvas,!0),this.keys={left:0,right:0,fire:0},this.isFireing=!1,this.canvasTexture,this.sphere,this.videoCanvas=document.createElement("canvas"),this.videoCanvas.id="jpgs",this.loadImage=function(){var a=this.videoCanvas.getContext("2d"),b=new Image;b.onload=function(){a.drawImage(b,0,0)},b.src="http://localhost:5000/image.jpg?"+(new Date).getTime()},this.AjaxControls={pressed:function(a){console.log(a+" was pressed"),ajax("/pressed?dir="+a,function(a){console.log(a)})},released:function(a){console.log(a+" was pressed"),ajax("/released?dir="+a,function(a){console.log(a)})}},this.ajax=function(a,b){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.onreadystatechange=function(){4==c.readyState&&200==c.status&&b(c.responseText)},c.open("GET",a,!0),c.send(null)},this.loopFunction=function(){1==this.keys.left&&(scene.cameras[0].cameraRotation.y-=.001),1==this.keys.right&&(scene.cameras[0].cameraRotation.y+=.001),1!=this.keys.fire||this.isFireing||(console.log("Fire!"),console.log("I need to do a raycasting right here"),this.isFireing=!0,this.castRay()),"up"==this.sphere.movingDir?(this.sphere.position.y-=.2,this.sphere.position.y<-8&&(console.log("I need to change"),this.sphere.movingDir="down")):"down"==this.sphere.movingDir&&(this.sphere.position.y+=.2,this.sphere.position.y>8&&(this.sphere.movingDir="up")),this.sphere.position.z-=.4,this.sphere.position.z<0&&(this.sphere.position.z=105),this.scene.render(),this.loadImage(),this.canvasTexture.update()}.bind(this),this.handleKeyDown=function(a){65==a.keyCode&&(this.keys.left=1,this.Controls.pressed("left")),68==a.keyCode&&(this.keys.right=1,this.Controls.pressed("right")),32==a.keyCode&&(this.keys.fire=1)},this.handleKeyUp=function(a){65==a.keyCode&&(this.keys.left=0,this.Controls.released("left")),68==a.keyCode&&(this.keys.right=0,this.Controls.released("right")),32==a.keyCode&&(this.keys.fire=0,this.isFireing=!1)},this.vecToLocal=function(a,b){var c=b.getWorldMatrix();return BABYLON.Vector3.TransformCoordinates(a,c)},this.castRay=function(){var a=scene.cameras[0].position,b=new BABYLON.Vector3(0,0,1);b=this.vecToLocal(b,scene.cameras[0]);var c=b.subtract(a);c=BABYLON.Vector3.Normalize(c);var d=300,e=new BABYLON.Ray(a,c,d),f=scene.pickWithRay(e);f.pickedMesh==this.sphere&&(f.pickedMesh.scaling.y+=.5,f.pickedMesh.scaling.x+=.5)},this.createScene=function(){var a=new BABYLON.Scene(this.engine),b=new BABYLON.FreeCamera("camera1",new BABYLON.Vector3(0,0,-10),a);b.setTarget(BABYLON.Vector3.Zero());new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0,1,0),a);this.sphere=BABYLON.Mesh.CreateSphere("sphere1",16,2,a),this.sphere.movingDir="up",this.sphere.position.z=60;var c=BABYLON.Mesh.CreatePlane("plane",100,a);c.scaling.y=.5,c.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;var d=new BABYLON.StandardMaterial("mat",a);this.canvasTexture=new BABYLON.DynamicTexture("dynamic texture",this.videoCanvas,a,!0),d.diffuseTexture=this.canvasTexture,c.material=d,c.parent=b,c.position=new BABYLON.Vector3(0,0,60);var e=new BABYLON.ScreenSpaceCanvas2D(a,{id:"ScreenCanvas"}),f=new BABYLON.Texture("target.png",a,!1,!0,1);return f.hasAlpha=!0,new BABYLON.Sprite2D(f,{parent:e,id:"sprite1",marginAlignment:"h: center, v: center"}),a},this.scene=this.createScene(),this.start=function(){this.engine.runRenderLoop(this.loopFunction),window.addEventListener("keydown",this.handleKeyDown.bind(this),!1),window.addEventListener("keyup",this.handleKeyUp.bind(this),!1),window.addEventListener("resize",function(){this.engine.resize()})}},game;window.addEventListener("DOMContentLoaded",function(){game=new Game,game.start()});